package org.opentestsystem.ap.imrt.iss.service;

import org.opentestsystem.ap.imrt.iss.config.ResourceServerProperties;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.http.HttpEntity;
import org.springframework.http.HttpHeaders;
import org.springframework.http.HttpMethod;
import org.springframework.security.core.AuthenticationException;
import org.springframework.security.oauth2.common.OAuth2AccessToken;
import org.springframework.security.oauth2.common.exceptions.InvalidTokenException;
import org.springframework.security.oauth2.provider.OAuth2Authentication;
import org.springframework.security.oauth2.provider.token.AccessTokenConverter;
import org.springframework.security.oauth2.provider.token.ResourceServerTokenServices;
import org.springframework.util.MultiValueMap;
import org.springframework.web.client.RestOperations;

import java.util.Map;

/**
 * Class to provide validation of OAuth2 tokens using an OpenAM Authorization server
 * Based on {@link org.springframework.security.oauth2.provider.token.RemoteTokenServices}
 * but modified to communicate with an OpenAM server
 */
public class OpenAmTokenServices implements ResourceServerTokenServices {
    private static final Logger logger = LoggerFactory.getLogger(OpenAmTokenServices.class);

    private final RestOperations restOperations;
    private final AccessTokenConverter tokenConverter;
    private final ResourceServerProperties properties;

    public OpenAmTokenServices(final ResourceServerProperties properties,
                               final AccessTokenConverter defaultAccessTokenConverter,
                               final RestOperations restOperations) {
        this.properties = properties;
        this.tokenConverter = defaultAccessTokenConverter;
        this.restOperations = restOperations;
    }

    @Override
    public OAuth2Authentication loadAuthentication(String accessToken) throws AuthenticationException, InvalidTokenException {
        logger.debug("loadAuthentication token {} url {}", accessToken, properties.getCheckTokenEndpointUrl());
        HttpHeaders headers = new HttpHeaders();
        headers.set("Authorization", "Bearer " + accessToken);
        Map map = restOperations.exchange(properties.getCheckTokenEndpointUrl(), HttpMethod.GET,
                new HttpEntity<MultiValueMap<String, String>>(null, headers), Map.class).getBody();

        logger.debug("authorization result {}", map);

        if (map.containsKey("error")) {
            logger.debug("check_token returned error: " + map.get("error"));
            throw new InvalidTokenException(accessToken);
        }

        @SuppressWarnings("unchecked")
        OAuth2Authentication result = tokenConverter.extractAuthentication(map);
        logger.debug("Result {} grant type {} scope {}", result, result.getOAuth2Request().getGrantType(), result.getOAuth2Request().getScope());
        return result;
    }

    @Override
    public OAuth2AccessToken readAccessToken(String accessToken) {
        throw new UnsupportedOperationException("Not supported: read access token");
    }
}
