package org.opentestsystem.ap.imrt.iss.controller;

import org.opentestsystem.ap.imrt.common.model.BaseItem;
import org.opentestsystem.ap.imrt.iss.dto.CountDto;
import org.opentestsystem.ap.imrt.iss.dto.ItemDto;
import org.opentestsystem.ap.imrt.iss.dto.ItemDtoConverter;
import org.opentestsystem.ap.imrt.iss.dto.PageDto;
import org.opentestsystem.ap.imrt.iss.dto.search.CountRequest;
import org.opentestsystem.ap.imrt.iss.dto.search.SearchRequest;
import org.opentestsystem.ap.imrt.iss.service.ItemSearchService;
import org.springframework.data.domain.Page;
import org.springframework.http.MediaType;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RequestBody;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RestController;

/**
 * Controller that handles item search
 */
@RestController
@RequestMapping("v1/items")
public class ItemSearchController {
    private final ItemSearchService itemSearchService;
    private final ItemDtoConverter itemDtoConverter;

    public ItemSearchController(final ItemSearchService itemSearchService, final ItemDtoConverter itemDtoConverter) {
        this.itemSearchService = itemSearchService;
        this.itemDtoConverter = itemDtoConverter;
    }

    /**
     * General Search endpoint
     *
     * @param searchCriteria {@link SearchRequest} containing the necessary filters
     * @return {@link PageDto<ItemDto>} of {@link ItemDto}
     */
    @PostMapping(value = "/search", produces = MediaType.APPLICATION_JSON_VALUE)
    PageDto<ItemDto> search(@RequestBody SearchRequest searchCriteria) {
        Page<BaseItem> page = itemSearchService.searchItems(searchCriteria);

        return new PageDto<>(
                itemDtoConverter.convert(page.getContent()),
                page.isLast(),
                page.isFirst(),
                page.getTotalPages(),
                page.getTotalElements()
        );
    }

    /**
     * Get counts by a specific property
     *
     * @param countRequest the {@link CountRequest}
     * @return the count of items grouped by {@link CountRequest}
     */
    @PostMapping(value = "/count", produces = MediaType.APPLICATION_JSON_VALUE)
    CountDto getCountByProperty(@RequestBody CountRequest countRequest) {
        if (!countRequest.isPopulated()) {
            throw new IllegalArgumentException("Request body is missing required fields.  Please check API documentation");
        }

        return new CountDto(countRequest.getGroupBy(), itemSearchService.getCounts(countRequest));
    }
}
