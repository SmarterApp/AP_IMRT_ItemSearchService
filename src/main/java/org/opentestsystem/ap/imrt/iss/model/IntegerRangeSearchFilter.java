package org.opentestsystem.ap.imrt.iss.model;

import com.google.common.annotations.VisibleForTesting;
import org.opentestsystem.ap.imrt.common.model.BaseItem;
import org.springframework.data.jpa.domain.Specification;
import org.springframework.data.jpa.domain.Specifications;

import static org.opentestsystem.ap.imrt.iss.service.filter.BaseItemFilterSpecifications.isBetween;
import static org.opentestsystem.ap.imrt.iss.service.filter.BaseItemFilterSpecifications.isNull;

/**
 * Find items whose property falls between two integers
 */
public class IntegerRangeSearchFilter extends AbstractSearchFilter implements SearchFilter {
    private final Integer min;
    private final Integer max;

    public IntegerRangeSearchFilter(final String filterProperty, final Integer min, final Integer max) {
        this(filterProperty, min, max, false);
    }

    public IntegerRangeSearchFilter(final String filterProperty, final Integer min, final Integer max, boolean includeNotSet) {
        super(filterProperty, includeNotSet);
        this.min = min;
        this.max = max;
    }

    @Override
    public boolean isEmpty() {
        return (min == null && max == null) && !isIncludeBlanks();
    }

    @Override
    public boolean isValid() {
        return true;
    }

    @Override
    public Specification<BaseItem> getSpecification() {
        Specification<BaseItem> specification;
        if (min == null && max == null && isIncludeBlanks()) {
            specification = isNull(getFilterProperty().getProperty());
        } else {
            specification = isBetween(getFilterProperty().getProperty(),
                    min,
                    max);

            if (isIncludeBlanks()) {
                specification = Specifications.where(specification).or(isNull(getFilterProperty().getProperty()));
            }
        }

        return specification;
    }

    @VisibleForTesting
    Integer getMin() {
        return min;
    }

    @VisibleForTesting
    Integer getMax() {
        return max;
    }

    @Override
    public FilterQuery getFilterQuery() {
        return null;
    }
}
