package org.opentestsystem.ap.imrt.iss.model;

import org.opentestsystem.ap.imrt.iss.dto.search.BooleanFlagFilter;
import org.opentestsystem.ap.imrt.iss.dto.search.ContainsFilter;
import org.opentestsystem.ap.imrt.iss.dto.search.DateRangeFilter;
import org.opentestsystem.ap.imrt.iss.dto.search.Filter;
import org.opentestsystem.ap.imrt.iss.dto.search.IntegerRangeFilter;
import org.opentestsystem.ap.imrt.iss.dto.search.MatchFilter;
import org.springframework.stereotype.Component;

import java.time.Instant;

/**
 * Handles converting {@link Filter} to the internal {@link SearchFilter} model
 */
@Component
public class SearchFilterConverter extends AbstractModelConverter<Filter, SearchFilter> implements ModelConverter<Filter, SearchFilter> {
    @Override
    public SearchFilter convert(final Filter filter) {
        switch (filter.getSearchProperty()) {
            case INTENDED_GRADE:
            case DOK:
            case WORKFLOW_STATUS:
            case ITEM_TYPE:
            case SUBJECT:
            case ORGANIZATION_TYPE_ID:
            case ASL_PROVIDED:
            case ASL_REQUIRED:
            case BRAILLE_PROVIDED:
            case BRAILLE_REQUIRED:
            case CC_PROVIDED:
            case CC_REQUIRED:
            case TRANSLATION_PROVIDED:
            case TRANSLATION_REQUIRED:
            case PRIMARY_CLAIM:
            case PRIMARY_TARGET:
            case SECONDARY_CLAIM:
            case SECONDARY_TARGET:
            case QUATERNARY_CLAIM:
            case QUATERNARY_TARGET:
            case TERTIARY_CLAIM:
            case TERTIARY_TARGET:
            case PERFORMANCE_TASK:
            case WRITING_PURPOSE:
            case TTS_VISUAL_REQUIRED:
            case TEST_CATEGORY:
            case SCORING_ENGINE:
            case ALLOW_CALCULATOR:
            case CURRENT_UPDATE_NEED_INTERNAL_RESOLUTION:
            case CURRENT_UPDATE_NEED_RESOLUTION:
            case ILLUSTRATED_GLOSSARY_REQUIRED:
            case TRANSLATED_GLOSSARY_REQUIRED:
                return convertMatchFilter(filter);
            case ITEM_ID:
            case STIMULUS_ID:
                return convertIdMatchFilter(filter);
            case ORGANIZATION_NAME:
            case ITEM_AUTHOR:
            case CREATED_BY:
            case CONTENT_TASK_MODEL:
            case PRIMARY_COMMON_CORE_STANDARD:
            case SECONDARY_COMMON_CORE_STANDARD:
            case TERTIARY_COMMON_CORE_STANDARD:
            case QUATERNARY_COMMON_CORE_STANDARD:
            case PRIMARY_CONTENT_DOMAIN:
            case SECONDARY_CONTENT_DOMAIN:
            case TERTIARY_CONTENT_DOMAIN:
            case QUATERNARY_CONTENT_DOMAIN:
                return convertContainsFilter(filter);
            case BEING_CREATED:
            case TTS_SIGHT_PROVIDED:
            case TTS_VISUAL_PROVIDED:
            case ASL_UPLOADED_PRIOR_TO_LAST_CONTENT_UPDATE:
            case BRAILLE_UPLOADED_PRIOR_TO_LAST_CONTENT_UPDATE:
            case CLOSED_CAPTIONING_UPLOADED_PRIOR_TO_LAST_CONTENT_UPDATE:
            case CONTENT_CHANGED_AFTER_OPERATIONAL:
            case HAS_UNRESOLVED_UPDATE_NEED:
            case ENGLISH_GLOSSARY_PROVIDED:
            case ILLUSTRATED_GLOSSARY_PROVIDED:
            case TRANSLATED_GLOSSARY_PROVIDED:
                return convertBooleanFlagFilter(filter);
            case DAYS_IN_WORKFLOW_STATUS:
                return convertDaysBetweenFilter(filter);
            case CREATE_DATE:
            case WORKFLOW_STATUS_UPDATE_DATE:
            case ENGLISH_CONTENT_LAST_UPDATED_DATE:
            case SPANISH_CONTENT_LAST_UPDATED_DATE:
            case UPDATED_DATE:
            case CURRENT_UPDATE_NEED_CREATED_DATE:
            case CURRENT_UPDATE_NEED_INTERNAL_RESOLUTION_DATE:
            case CURRENT_UPDATE_NEED_RESOLUTION_DATE:
                return convertDateRangeFilter(filter);
            case CALCULATED_EXPOSURES_COUNT:
            case CALCULATED_FORM_COUNT:
            case ITEM_DIFFICULTY_QUINTILE:
            case SPANISH_PASSAGES_COUNT:
            case ENGLISH_PASSAGES_COUNT:
                return convertIntegerRangeFilter(filter);
            case FORM_TYPE:
            case ASSESSMENT_TYPE:
                return convertFormMatchFilter(filter);
            case ASSOCIATED_ITEM_COUNT:
                return convertAssociatedItemCountFilter(filter);
            default:
                throw new IllegalArgumentException("Filter property is unrecognized " + filter.getSearchProperty().getProperty());
        }
    }

    private SearchFilter convertMatchFilter(Filter filter) {
        if (!(filter instanceof MatchFilter)) {
            throw new IllegalStateException("Filter property should be of match type filter.  Please check configuration");
        }

        return new MatchSearchFilter(filter.getSearchProperty(), ((MatchFilter) filter).getValues(), filter.isIncludeBlanks());
    }

    private SearchFilter convertIdMatchFilter(Filter filter) {
        if (!(filter instanceof MatchFilter)) {
            throw new IllegalStateException("Filter property should be of match type filter.  Please check configuration");
        }

        return new IdMatchSearchFilter(filter.getSearchProperty(), ((MatchFilter) filter).getValues(), filter.isIncludeBlanks());
    }

    private SearchFilter convertContainsFilter(Filter filter) {
        if (!(filter instanceof ContainsFilter)) {
            throw new IllegalStateException("Filter property should be of contains type filter.  Please check configuration");
        }

        return new ContainsSearchFilter(filter.getSearchProperty(), ((ContainsFilter) filter).getValues(), filter.isIncludeBlanks());
    }

    private SearchFilter convertDateRangeFilter(Filter filter) {
        if (!(filter instanceof DateRangeFilter)) {
            throw new IllegalStateException("Filter property should be of dateRange type filter.  Please check configuration");
        }

        DateRangeFilter dateRangeFilter = (DateRangeFilter) filter;
        Instant to = dateRangeFilter.getTo().orElse(null);
        Instant from = dateRangeFilter.getFrom().orElse(null);

        return new DateRangeSearchFilter(filter.getSearchProperty(), to, from, filter.isIncludeBlanks());
    }

    private SearchFilter convertIntegerRangeFilter(Filter filter) {
        if (!(filter instanceof IntegerRangeFilter)) {
            throw new IllegalStateException("Filter property should be of integerRange type filter.  Please check configuration");
        }

        IntegerRangeFilter integerRangeFilter = (IntegerRangeFilter) filter;
        Integer min = integerRangeFilter.getMin().orElse(null);
        Integer max = integerRangeFilter.getMax().orElse(null);

        return new IntegerRangeSearchFilter(filter.getSearchProperty(), min, max, filter.isIncludeBlanks());
    }

    private SearchFilter convertAssociatedItemCountFilter(Filter filter) {
        if (!(filter instanceof IntegerRangeFilter)) {
            throw new IllegalStateException("Filter property should be of integerRange type filter.  Please check configuration");
        }

        IntegerRangeFilter integerRangeFilter = (IntegerRangeFilter) filter;
        Integer min = integerRangeFilter.getMin().orElse(null);
        Integer max = integerRangeFilter.getMax().orElse(null);

        return new AssociatedItemCountSearchFilter(filter.getSearchProperty(), min, max);
    }

    private SearchFilter convertBooleanFlagFilter(Filter filter) {
        if (!(filter instanceof BooleanFlagFilter)) {
            throw new IllegalStateException("Filter property should be of booleanFlag type filter.  Please check configuration");
        }

        return new BooleanFlagSearchFilter(filter.getSearchProperty(), ((BooleanFlagFilter) filter).isValue(), filter.isIncludeBlanks());
    }

    private SearchFilter convertDaysBetweenFilter(Filter filter) {
        if (!(filter instanceof IntegerRangeFilter)) {
            throw new IllegalStateException("Filter property should be of integerRange type filter.  Please check configuration");
        }

        IntegerRangeFilter integerRangeFilter = (IntegerRangeFilter) filter;
        Integer min = integerRangeFilter.getMin().orElse(null);
        Integer max = integerRangeFilter.getMax().orElse(null);

        return new DaysBetweenSearchFilter(filter.getSearchProperty(), min, max);
    }

    private SearchFilter convertFormMatchFilter(Filter filter) {
        if (!(filter instanceof MatchFilter)) {
            throw new IllegalStateException("Filter property should be of match type filter.  Please check configuration");
        }

        return new FormMatchSearchFilter(filter.getSearchProperty(), ((MatchFilter) filter).getValues(), filter.isIncludeBlanks());
    }
}