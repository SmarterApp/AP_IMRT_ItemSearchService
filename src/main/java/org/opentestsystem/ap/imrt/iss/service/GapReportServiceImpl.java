package org.opentestsystem.ap.imrt.iss.service;

import org.apache.poi.xssf.usermodel.XSSFWorkbook;
import org.opentestsystem.ap.imrt.iss.dto.search.SearchProperty;
import org.opentestsystem.ap.imrt.iss.model.SearchFilter;
import org.opentestsystem.ap.imrt.iss.model.reports.gap.GapReport;
import org.opentestsystem.ap.imrt.iss.model.reports.gap.GapReportBuilder;
import org.opentestsystem.ap.imrt.iss.repository.GapReportRepository;
import org.springframework.stereotype.Service;

import java.io.File;
import java.io.FileOutputStream;
import java.io.IOException;
import java.nio.file.Files;
import java.nio.file.Path;
import java.text.DateFormat;
import java.text.SimpleDateFormat;
import java.time.Instant;
import java.util.Collection;
import java.util.Date;
import java.util.List;
import java.util.Map;
import java.util.Optional;
import java.util.UUID;
import java.util.stream.Collectors;

@Service
public class GapReportServiceImpl implements GapReportService {
    private final GapReportRepository gapReportRepository;
    private final GapReportBuilder gapReportBuilder;

    public GapReportServiceImpl(final GapReportRepository gapReportRepository,
                                final GapReportBuilder gapReportBuilder) {
        this.gapReportRepository = gapReportRepository;
        this.gapReportBuilder = gapReportBuilder;
    }

    @Override
    public Optional<File> getGapReport(final Collection<SearchFilter> searchFilters,
                                       final Collection<SearchProperty> groups) {
        if (containsInvalidFilters(searchFilters)) {
            return Optional.empty();
        }

        final List<String> invalidGroupProperties = groups.stream()
                .filter(g -> !g.isSupportsCounts())
                .map(SearchProperty::getProperty)
                .collect(Collectors.toList());

        if (!invalidGroupProperties.isEmpty()) {
            throw new IllegalArgumentException("The following group(s) are not supported: " + String.join(", ", invalidGroupProperties));
        }

        final List<Map<String, Object>> results = gapReportRepository.getGapReport(searchFilters, groups);

        final XSSFWorkbook workbook = gapReportBuilder.getReport(new GapReport(searchFilters,
                groups,
                results,
                Instant.now()));

        try {
            final Path path = Files.createTempDirectory(UUID.randomUUID().toString());
            final DateFormat df = new SimpleDateFormat("yyyyMMddhhmmss");
            final File excelFile = new File(path.toFile(), "gap-report-" + df.format(new Date()) + ".xlsx");

            try (final FileOutputStream fso = new FileOutputStream(excelFile)) {
                workbook.write(fso);
            }

            return Optional.of(excelFile);
        } catch (final IOException e) {
            throw new RuntimeException("Unhandled exception while creating Gap Report excel file", e);
        }
    }

    /**
     * Determine if any of the {@link org.opentestsystem.ap.imrt.iss.model.SearchFilter}s contain invalid values.
     *
     * @param filters The collection of {@link org.opentestsystem.ap.imrt.iss.model.SearchFilter}s to evaluate
     * @return True if any of the {@link org.opentestsystem.ap.imrt.iss.model.SearchFilter}s are invalid; otherwise
     * false
     */
    private boolean containsInvalidFilters(Collection<SearchFilter> filters) {
        return filters.stream().anyMatch(searchFilter -> !searchFilter.containsValidFilterValues());
    }
}
