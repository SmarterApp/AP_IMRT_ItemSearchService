package org.opentestsystem.ap.imrt.iss.model;

import com.google.common.annotations.VisibleForTesting;
import org.opentestsystem.ap.imrt.common.model.BaseItem;
import org.springframework.data.jpa.domain.Specification;

import java.time.Instant;

import static org.opentestsystem.ap.imrt.iss.service.filter.BaseItemFilterSpecifications.isBetween;
import static org.opentestsystem.ap.imrt.iss.service.filter.BaseItemFilterSpecifications.isGreaterThanOrEqualTo;
import static org.opentestsystem.ap.imrt.iss.service.filter.BaseItemFilterSpecifications.isLessThanOrEqualTo;

/**
 * Handles date range filtering
 */
public class DateRangeSearchFilter extends AbstractSearchFilter implements SearchFilter {
    private final Instant to;
    private final Instant from;

    public DateRangeSearchFilter(final String filterProperty, final Instant to, final Instant from) {
        super(filterProperty);
        this.to = to;
        this.from = from;
    }

    @Override
    public boolean isEmpty() {
        return to == null && from == null;
    }

    @Override
    public boolean isValid() {
        return true;
    }

    @Override
    public Specification<BaseItem> getSpecification() {
        // If we only have the 'from' date, return a "greater than or equal to" filter
        if (from != null && to == null) {
            return isGreaterThanOrEqualTo(getFilterProperty(), from);
        }

        // If we only have the 'to' date, return a "less than or equal to" filter
        if (to != null && from == null) {
            return isLessThanOrEqualTo(getFilterProperty(), to);
        }

        // We have both the 'from' and 'to' dates, so a "between" filter should be returned
        return isBetween(getFilterProperty(), from, to);
    }

    @VisibleForTesting
    Instant getTo() {
        return to;
    }

    @VisibleForTesting
    Instant getFrom() {
        return from;
    }
}