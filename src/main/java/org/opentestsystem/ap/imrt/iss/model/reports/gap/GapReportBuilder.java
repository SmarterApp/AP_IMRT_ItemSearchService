package org.opentestsystem.ap.imrt.iss.model.reports.gap;

import org.apache.commons.lang.StringUtils;
import org.apache.poi.xssf.usermodel.XSSFCell;
import org.apache.poi.xssf.usermodel.XSSFCellStyle;
import org.apache.poi.xssf.usermodel.XSSFColor;
import org.apache.poi.xssf.usermodel.XSSFFont;
import org.apache.poi.xssf.usermodel.XSSFRow;
import org.apache.poi.xssf.usermodel.XSSFSheet;
import org.apache.poi.xssf.usermodel.XSSFWorkbook;
import org.opentestsystem.ap.imrt.iss.dto.search.SearchProperty;
import org.opentestsystem.ap.imrt.iss.model.BooleanFlagSearchFilter;
import org.opentestsystem.ap.imrt.iss.model.ContainsSearchFilter;
import org.opentestsystem.ap.imrt.iss.model.DateRangeSearchFilter;
import org.opentestsystem.ap.imrt.iss.model.DaysBetweenSearchFilter;
import org.opentestsystem.ap.imrt.iss.model.IdMatchSearchFilter;
import org.opentestsystem.ap.imrt.iss.model.IntegerRangeSearchFilter;
import org.opentestsystem.ap.imrt.iss.model.MatchSearchFilter;
import org.opentestsystem.ap.imrt.iss.model.SearchFilter;

import java.awt.Color;
import java.io.FileOutputStream;
import java.io.IOException;
import java.util.Arrays;
import java.util.Collections;
import java.util.Date;
import java.util.HashMap;
import java.util.List;
import java.util.Map;
import java.util.Optional;

public class GapReportBuilder {

    public void getReport(final GapReport gapReport) throws IOException {
        final Map<String, Short> difficultyQuintileColumnIndices = new HashMap<>();

        final XSSFWorkbook gapReportWorkbook = new XSSFWorkbook();
        gapReportWorkbook.getCellStyleAt(0).getFont().setFontHeightInPoints((short) 12);

        final XSSFFont boldFont = gapReportWorkbook.createFont();
        boldFont.setBold(true);
        boldFont.setFontName(gapReportWorkbook.getCellStyleAt(0).getFont().getFontName());
        boldFont.setFontHeight(gapReportWorkbook.getCellStyleAt(0).getFont().getFontHeight());
        final XSSFFont italicFont = gapReportWorkbook.createFont();
        italicFont.setItalic(true);
        italicFont.setFontName(gapReportWorkbook.getCellStyleAt(0).getFont().getFontName());
        italicFont.setColor(new XSSFColor(Color.GRAY));

        // -------------------------------------------------------------------------------------------------------------
        // REPORT PARAMETERS SHEET
        // -------------------------------------------------------------------------------------------------------------
        final XSSFSheet reportParametersSheet = gapReportWorkbook.createSheet("Report Parameters");

        // Add date row
        final XSSFRow createdDateRow = reportParametersSheet.createRow(0);
        final XSSFCell createDateLabelCell = createdDateRow.createCell(0);
        final XSSFCell createdDateCell = createdDateRow.createCell(1);

        final XSSFCellStyle boldTextCellStyle = gapReportWorkbook.createCellStyle();
        boldTextCellStyle.setFont(boldFont);
        final XSSFCellStyle italicTextCellStyle = gapReportWorkbook.createCellStyle();
        italicTextCellStyle.setFont(italicFont);
        italicTextCellStyle.setFillForegroundColor(new XSSFColor(Color.GRAY));

        createDateLabelCell.setCellValue("Date Created");
        createDateLabelCell.setCellStyle(boldTextCellStyle);
        createdDateCell.setCellValue(Date.from(gapReport.getCreatedDate()).toString());

        // Add search filters
        final XSSFRow filtersHeaderRow = reportParametersSheet.createRow(reportParametersSheet.getLastRowNum() + 1);
        final XSSFCell filtersHeaderLabelCell = filtersHeaderRow.createCell(0);
        filtersHeaderLabelCell.setCellValue("Filters");
        filtersHeaderLabelCell.setCellStyle(boldTextCellStyle);

        if (!gapReport.getFilters().isEmpty()) {
            for (final SearchFilter filter : gapReport.getFilters()) {
                if (filtersHeaderRow.getLastCellNum() == 1) {
                    final XSSFCell firstFilterLabelCell = filtersHeaderRow.createCell(filtersHeaderRow.getLastCellNum());
                    firstFilterLabelCell.setCellValue(filter.getFilterProperty().getProperty());

                    final List<String> filterValues = getFilterValues(filter);

                    int subsequentFilterValuesRowIndex = filtersHeaderRow.getRowNum();
                    for (int i = 0; i < filterValues.size(); i++) {
                        if (i == 0) {
                            final XSSFCell firstFilterValueCell = filtersHeaderRow.createCell(filtersHeaderRow.getLastCellNum());
                            firstFilterValueCell.setCellValue(filterValues.get(0));
                        } else {
                            final XSSFRow filterValueRow = reportParametersSheet.createRow(++subsequentFilterValuesRowIndex);
                            final XSSFCell filterValueCell = filterValueRow.createCell(2);
                            filterValueCell.setCellValue(filterValues.get(i));
                        }
                    }
                } else {
                    final List<String> filterValues = getFilterValues(filter);
                    final XSSFRow filterRow = reportParametersSheet.createRow(reportParametersSheet.getLastRowNum() + 1);
                    XSSFCell filterLabelCell = filterRow.createCell(1);
                    filterLabelCell.setCellValue(filter.getFilterProperty().getProperty());

                    int subsequentFilterValuesRowIndex = filterRow.getRowNum();
                    for (int i = 0; i < filterValues.size(); i++) {
                        if (i == 0) {
                            final XSSFCell firstFilterValueCell = filterRow.createCell(2);
                            firstFilterValueCell.setCellValue(filterValues.get(0));
                        } else {
                            final XSSFRow filterValueRow = reportParametersSheet.createRow(++subsequentFilterValuesRowIndex);
                            final XSSFCell filterValueCell = filterValueRow.createCell(2);
                            filterValueCell.setCellValue(filterValues.get(i));
                        }
                    }
                }
            }
        } else {
            // add a row to indicate no filters were provided
            filtersHeaderLabelCell.setCellValue("No search filters provided");
            filtersHeaderLabelCell.setCellStyle(italicTextCellStyle);
        }

        int groupRowIndex = reportParametersSheet.getLastRowNum() + 1;
        final XSSFRow groupsHeaderRow = reportParametersSheet.createRow(groupRowIndex);
        final XSSFCell groupsHeaderCell = groupsHeaderRow.createCell(0);
        groupsHeaderCell.setCellValue("Groups");
        groupsHeaderCell.setCellStyle(boldTextCellStyle);

        for (final SearchProperty group : gapReport.getGroupFilters()) {
            if (groupsHeaderRow.getLastCellNum() == 1) {
                final XSSFCell firstGroupValueCell = groupsHeaderRow.createCell(groupsHeaderRow.getLastCellNum());
                firstGroupValueCell.setCellValue(group.getProperty());
            } else {
                final XSSFRow groupRow = reportParametersSheet.createRow(++groupRowIndex);
                final XSSFCell groupCell = groupRow.createCell(1);
                groupCell.setCellValue(group.getProperty());
            }
        }

        reportParametersSheet.autoSizeColumn(0);
        reportParametersSheet.autoSizeColumn(1);
        reportParametersSheet.autoSizeColumn(2);

        // -------------------------------------------------------------------------------------------------------------
        // REPORT DETAILS SHEET
        // -------------------------------------------------------------------------------------------------------------
        final XSSFSheet reportSheet = gapReportWorkbook.createSheet("Report");

        for (int i = 0; i < gapReport.getGapReportRecords().size(); i++) {
            if (i == 0) {
                final XSSFRow headerRow = reportSheet.createRow(0);
                // TODO:  Get "english" labels for headers
                for (final String headerText : gapReport.getGapReportRecords().get(i).keySet()) {
                    short cellIndex = headerRow.getLastCellNum();
                    if (cellIndex < 0) {
                        cellIndex = 0;
                    }

                    final XSSFCell headerCell = headerRow.createCell(cellIndex);
                    headerCell.setCellValue(headerText);
                    headerCell.setCellStyle(boldTextCellStyle);

                    if (headerText.toLowerCase().matches("(actual|desired)(.+)")) {
                        difficultyQuintileColumnIndices.put(headerText, cellIndex);
                    }
                }

                for (int c = 0; c < headerRow.getLastCellNum(); c++) {
                    reportSheet.autoSizeColumn(c);
                }
            }

            final XSSFRow detailRow = reportSheet.createRow(i + 1);
            for (final Object value : gapReport.getGapReportRecords().get(i).values()) {
                final String val = Optional.ofNullable(value).isPresent()
                        ? value.toString()
                        : StringUtils.EMPTY;
                short cellIndex = detailRow.getLastCellNum();
                if (cellIndex < 0) {
                    cellIndex = 0;
                }

                final XSSFCell detailCell = detailRow.createCell(cellIndex);
                detailCell.setCellValue(val);
            }

            // TODO: add formula (check requirements) something like [actual difficulty - desired difficulty]
        }

        // write file
        final String excelFileName = "/Users/jeffjohnson/Desktop/test.xlsx";
        final FileOutputStream fileOutputStream = new FileOutputStream(excelFileName);

        gapReportWorkbook.write(fileOutputStream);
        fileOutputStream.flush();
        fileOutputStream.close();
    }

    private List<String> getFilterValues(final SearchFilter filter) {
        List<String> searchFilterValues;

        // No need for FormMatchSearchFilter; nothing with forms supports counts
        if (filter instanceof BooleanFlagSearchFilter) {
            searchFilterValues = Collections.singletonList(String.valueOf(((BooleanFlagSearchFilter) filter).getFlag()));
        } else if (filter instanceof ContainsSearchFilter) {
            searchFilterValues = ((ContainsSearchFilter) filter).getFilterValues();
        } else if (filter instanceof DateRangeSearchFilter) {
            final DateRangeSearchFilter dateRangeSearchFilter = (DateRangeSearchFilter) filter;
            searchFilterValues = Arrays.asList(String.format("from: %s", dateRangeSearchFilter.getFrom()),
                    String.format("to: %s", dateRangeSearchFilter.getTo()));
        } else if (filter instanceof DaysBetweenSearchFilter) {
            final DaysBetweenSearchFilter daysBetweenSearchFilter = (DaysBetweenSearchFilter) filter;
            searchFilterValues = Arrays.asList(String.format("min: %d", daysBetweenSearchFilter.getMin()),
                    String.format("max: %d", daysBetweenSearchFilter.getMax()));
        } else if (filter instanceof IdMatchSearchFilter) {
            searchFilterValues = ((IdMatchSearchFilter) filter).getFilterValues();
        } else if (filter instanceof IntegerRangeSearchFilter) {
            final IntegerRangeSearchFilter integerRangeSearchFilter = (IntegerRangeSearchFilter) filter;
            searchFilterValues = Collections.emptyList(); // TODO:  set filter values
        } else if (filter instanceof MatchSearchFilter) {
            searchFilterValues = ((MatchSearchFilter) filter).getFilterValues();
        } else {
            searchFilterValues = Collections.emptyList();
        }

        return searchFilterValues;
    }
}
