package org.opentestsystem.ap.imrt.iss.service;

import org.junit.Test;
import org.junit.runner.RunWith;
import org.opentestsystem.ap.common.model.EqItem;
import org.opentestsystem.ap.common.model.McItem;
import org.opentestsystem.ap.imrt.common.model.BaseItem;
import org.opentestsystem.ap.imrt.common.model.ImrtItem;
import org.opentestsystem.ap.imrt.iss.ItemSearchServiceApplicationConfiguration;
import org.opentestsystem.ap.imrt.iss.builder.ImrtItemBuilder;
import org.opentestsystem.ap.imrt.iss.dto.search.MatchFilter;
import org.opentestsystem.ap.imrt.iss.dto.search.SearchRequest;
import org.opentestsystem.ap.imrt.iss.repository.ImrtItemSearchRepository;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.test.context.SpringBootTest;
import org.springframework.context.annotation.Import;
import org.springframework.data.jpa.repository.config.EnableJpaAuditing;
import org.springframework.test.context.junit4.SpringRunner;
import org.springframework.transaction.annotation.Transactional;

import java.util.Arrays;
import java.util.Collections;

import static org.assertj.core.api.Assertions.assertThat;

@RunWith(SpringRunner.class)
@SpringBootTest
@Transactional
@Import(ItemSearchServiceApplicationConfiguration.class)
@EnableJpaAuditing
public class ItemSearchServiceImplIntegrationTest {

    @Autowired
    private ItemSearchService itemSearchService;

    @Autowired
    private ImrtItemSearchRepository itemRepository;

    @Test
    public void shouldFindItems() {
        EqItem eq = new EqItem("123");
        McItem mc = new McItem("345");
        ImrtItem item = new ImrtItemBuilder()
                .withId("123")
                .withItemJson(eq)
                .withGrade("3")
                .withSubject("ELA")
                .build();

        ImrtItem item2 = new ImrtItemBuilder()
                .withId("345")
                .withItemJson(mc)
                .withGrade("4")
                .withSubject("MATH")
                .build();

        itemRepository.save(item);
        itemRepository.save(item2);

        MatchFilter itemIdFilter = new MatchFilter("itemId", Arrays.asList("123", "345"));

        MatchFilter gradeFilter = new MatchFilter("grade", Collections.singletonList("3"));

        SearchRequest searchCriteria = new SearchRequest(Arrays.asList(itemIdFilter, gradeFilter));

        Iterable<BaseItem> items = itemSearchService.searchItems(searchCriteria);

        assertThat(items).hasSize(1);
        assertThat(items.iterator().next().getId()).isEqualTo(item.getId());

        searchCriteria = new SearchRequest(Collections.singletonList(itemIdFilter));

        items = itemSearchService.searchItems(searchCriteria);
        assertThat(items).hasSize(2);

        searchCriteria = new SearchRequest(Collections.singletonList(new MatchFilter("grade", Arrays.asList("3","4"))));

        items = itemSearchService.searchItems(searchCriteria);
        assertThat(items).hasSize(2);

        searchCriteria = new SearchRequest(Collections.singletonList(new MatchFilter("grade", Arrays.asList("2","4"))));
        items = itemSearchService.searchItems(searchCriteria);
        assertThat(items).hasSize(1);
        assertThat(items.iterator().next().getId()).isEqualTo("345");

        searchCriteria = new SearchRequest(Arrays.asList(
                new MatchFilter("grade", Arrays.asList("2","3")),
                new MatchFilter("subject", Collections.singletonList("ELA"))
        ));

        items = itemSearchService.searchItems(searchCriteria);
        assertThat(items).hasSize(1);
        assertThat(items.iterator().next().getId()).isEqualTo("123");
    }
}

