package org.opentestsystem.ap.imrt.iss.model;

import org.junit.Before;
import org.junit.Test;

import java.sql.Timestamp;
import java.time.Instant;
import java.time.temporal.ChronoUnit;

import static org.assertj.core.api.Assertions.assertThat;
import static org.opentestsystem.ap.imrt.iss.dto.search.SearchProperty.ASSIGNED_DATES;

public class AssignedDatesDateRangeSearchFilterTest {
    private static final String TO_PARAM = ASSIGNED_DATES.getProperty() + "To";
    private static final String FROM_PARAM = ASSIGNED_DATES.getProperty() + "From";
    private SearchPermissions searchPermissions;

    @Before
    public void setUp() {
        searchPermissions = new SearchPermissions();
    }

    @Test
    public void shouldHandleToQuery() {
        Instant to = Instant.now();
        AssignedDatesDateRangeSearchFilter filter = new AssignedDatesDateRangeSearchFilter(ASSIGNED_DATES, to, null);

        FilterQuery filterQuery = filter.getFilterQuery(searchPermissions).get();

        assertThat(filterQuery.getQuery()).isEqualTo(
            "key = (select item_key from item_assignment where assigned_date <= :" + TO_PARAM + " group by item_key) ");
        assertThat(filterQuery.getMapSqlProperties()).hasSize(1);
        assertThat(filterQuery.getMapSqlProperties()).containsKeys(TO_PARAM);
        assertThat(filterQuery.getMapSqlProperties().get(TO_PARAM)).isEqualTo(Timestamp.from(to));
    }

    @Test
    public void shouldHandleFromQuery() {
        Instant from = Instant.now();
        AssignedDatesDateRangeSearchFilter filter = new AssignedDatesDateRangeSearchFilter(ASSIGNED_DATES, null, from);

        FilterQuery filterQuery = filter.getFilterQuery(searchPermissions).get();

        assertThat(filterQuery.getQuery()).isEqualTo(
            "key = (select item_key from item_assignment where assigned_date >= :" + FROM_PARAM + " group by item_key) ");
        assertThat(filterQuery.getMapSqlProperties()).hasSize(1);
        assertThat(filterQuery.getMapSqlProperties()).containsKeys(FROM_PARAM);
        assertThat(filterQuery.getMapSqlProperties().get(FROM_PARAM)).isEqualTo(Timestamp.from(from));
    }

    @Test
    public void shouldHandleFromAndToQuery() {
        Instant from = Instant.now().minus(1, ChronoUnit.DAYS);
        Instant to = Instant.now();
        AssignedDatesDateRangeSearchFilter filter = new AssignedDatesDateRangeSearchFilter(ASSIGNED_DATES, to, from);

        FilterQuery filterQuery = filter.getFilterQuery(searchPermissions).get();

        assertThat(filterQuery.getQuery()).isEqualTo(
            "key = (select item_key from item_assignment where assigned_date <= :" + TO_PARAM + " AND assigned_date >= :" + FROM_PARAM + " group by item_key) ");
        assertThat(filterQuery.getMapSqlProperties()).hasSize(2);
        assertThat(filterQuery.getMapSqlProperties()).containsKeys(TO_PARAM, FROM_PARAM);
        assertThat(filterQuery.getMapSqlProperties().get(FROM_PARAM)).isEqualTo(Timestamp.from(from));
        assertThat(filterQuery.getMapSqlProperties().get(TO_PARAM)).isEqualTo(Timestamp.from(to));
    }
}