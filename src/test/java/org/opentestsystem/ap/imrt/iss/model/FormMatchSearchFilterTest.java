package org.opentestsystem.ap.imrt.iss.model;

import org.junit.Before;
import org.junit.Test;

import java.util.Collection;
import java.util.Collections;

import static org.assertj.core.api.Assertions.assertThat;
import static org.opentestsystem.ap.imrt.iss.dto.search.SearchProperty.FORM_TYPE;

public class FormMatchSearchFilterTest {
    private SearchPermissions searchPermissions;

    @Before
    public void setUp() {
        searchPermissions = new SearchPermissions();
    }

    @Test
    @SuppressWarnings("unchecked")
    public void shouldCreateBlanksQuery() {
        FormMatchSearchFilter filter = new FormMatchSearchFilter(FORM_TYPE, Collections.emptyList(), true);

        FilterQuery query = filter.getFilterQuery(searchPermissions).get();

        final String expectedSql = FormMatchSearchFilter.INCLUDE_BLANKS + " OR " + String.format(FormMatchSearchFilter.FILTER, FORM_TYPE.getColumnName(), FORM_TYPE.getProperty());
        assertThat(query.getQuery()).isEqualTo(expectedSql);
        assertThat((Collection) query.getMapSqlProperties().get(FORM_TYPE.getProperty())).containsExactly("");
    }

    @Test
    @SuppressWarnings("unchecked")
    public void shouldCreateFilterQuery() {
        FormMatchSearchFilter filter = new FormMatchSearchFilter(FORM_TYPE, Collections.singletonList("test"));

        FilterQuery query = filter.getFilterQuery(searchPermissions).get();

        assertThat(query.getQuery()).isEqualTo(String.format(FormMatchSearchFilter.FILTER, FORM_TYPE.getColumnName(), FORM_TYPE.getProperty()));
        assertThat((Collection) query.getMapSqlProperties().get(FORM_TYPE.getProperty())).containsExactly("test");
    }

    @Test
    @SuppressWarnings("unchecked")
    public void shouldCreateIncludeBlanksAndFilterQuery() {
        FormMatchSearchFilter filter = new FormMatchSearchFilter(FORM_TYPE, Collections.singletonList("test"), true);

        FilterQuery query = filter.getFilterQuery(searchPermissions).get();

        final String expectedSql = FormMatchSearchFilter.INCLUDE_BLANKS + " OR " + String.format(FormMatchSearchFilter.FILTER, FORM_TYPE.getColumnName(), FORM_TYPE.getProperty());
        assertThat(query.getQuery()).isEqualTo(expectedSql);
        assertThat((Collection) query.getMapSqlProperties().get(FORM_TYPE.getProperty())).containsExactly("", "test");
    }
}