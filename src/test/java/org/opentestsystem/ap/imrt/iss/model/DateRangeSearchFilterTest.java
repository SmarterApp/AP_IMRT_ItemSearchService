package org.opentestsystem.ap.imrt.iss.model;


import org.junit.Test;

import java.time.Instant;
import java.time.temporal.ChronoUnit;

import static org.assertj.core.api.Assertions.assertThat;
import static org.opentestsystem.ap.imrt.iss.dto.search.SearchProperty.WORKFLOW_STATUS_UPDATE_DATE;

public class DateRangeSearchFilterTest {
    private static final String TO_PARAM = WORKFLOW_STATUS_UPDATE_DATE.getProperty() + "To";
    private static final String FROM_PARAM = WORKFLOW_STATUS_UPDATE_DATE.getProperty() + "From";

    @Test
    public void shouldHandleToQuery() {
        Instant to = Instant.now();
        DateRangeSearchFilter filter = new DateRangeSearchFilter(WORKFLOW_STATUS_UPDATE_DATE.getProperty(), to, null);

        FilterQuery filterQuery = filter.getFilterQuery();

        assertThat(filterQuery.getQuery()).isEqualTo("workflow_status_set_at <= :workflowStatusUpdatedateTo");
        assertThat(filterQuery.getMapSqlProperties()).hasSize(1);
        assertThat(filterQuery.getMapSqlProperties()).containsKeys(TO_PARAM);
        assertThat(filterQuery.getMapSqlProperties().get(TO_PARAM)).isEqualTo(to);
    }

    @Test
    public void shouldHandleFromQuery() {
        Instant from = Instant.now();
        DateRangeSearchFilter filter = new DateRangeSearchFilter(WORKFLOW_STATUS_UPDATE_DATE.getProperty(), null, from);

        FilterQuery filterQuery = filter.getFilterQuery();

        assertThat(filterQuery.getQuery()).isEqualTo("workflow_status_set_at >= :workflowStatusUpdatedateFrom");
        assertThat(filterQuery.getMapSqlProperties()).hasSize(1);
        assertThat(filterQuery.getMapSqlProperties()).containsKeys(FROM_PARAM);
        assertThat(filterQuery.getMapSqlProperties().get(FROM_PARAM)).isEqualTo(from);
    }

    @Test
    public void shouldHandleFromAndToQuery() {
        Instant from = Instant.now().minus(1, ChronoUnit.DAYS);
        Instant to = Instant.now();
        DateRangeSearchFilter filter = new DateRangeSearchFilter(WORKFLOW_STATUS_UPDATE_DATE.getProperty(), to, from);

        FilterQuery filterQuery = filter.getFilterQuery();

        assertThat(filterQuery.getQuery()).isEqualTo("workflow_status_set_at between :" + FROM_PARAM + " AND :" + TO_PARAM);
        assertThat(filterQuery.getMapSqlProperties()).hasSize(2);
        assertThat(filterQuery.getMapSqlProperties()).containsKeys(TO_PARAM, FROM_PARAM);
        assertThat(filterQuery.getMapSqlProperties().get(FROM_PARAM)).isEqualTo(from);
        assertThat(filterQuery.getMapSqlProperties().get(TO_PARAM)).isEqualTo(to);
    }
}